{% extends "base.html" %}
{% block title %}Quiz â€“ {{ language }}{% endblock %}

{% block content %}
<h1>{{ language | capitalize }} Quiz</h1>

<div id="quiz-box">Loading...</div>

<script>
const questions = {{ questions|tojson }};
let currentIndex = 0;
let score = 0;

function showQuestion() {
    if (currentIndex >= questions.length) {
        document.getElementById("quiz-box").innerHTML = `
            <h2>Quiz Finished!</h2>
            <p>Your Score: ${score} / ${questions.length}</p>
            <a href="{{ url_for('home') }}" class="btn">Back to Home</a>
        `;
        return;
    }

    const q = questions[currentIndex];
    const quizBox = document.getElementById("quiz-box");

    quizBox.innerHTML = `
        <h2>Question ${currentIndex + 1} / ${questions.length}</h2>
        <p>${q.question}</p>
        <ul id="options-list"></ul>
    `;

    const ul = document.getElementById("options-list");

    q.options.forEach(opt => {
        const li = document.createElement("li");
        const btn = document.createElement("button");
        btn.textContent = opt;
        btn.className = "btn";

        btn.addEventListener("click", () => {
            console.log("Button clicked:", opt); // Browser console debug

            submitAnswer(opt, q.answer, q.options);
        });

        li.appendChild(btn);
        ul.appendChild(li);
    });
}

function submitAnswer(selected, correct, options) {
    if (selected === correct) score++;

    const quizBox = document.getElementById("quiz-box");

    fetch(`/quiz/{{ language }}/answer`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            question: questions[currentIndex].question,
            selected: selected,
            correct: correct,
            options: options
        })
    })
    .then(res => res.json())
    .then(data => {
        // Automatically format AI explanation into numbered bullets
        const explanationFormatted = formatExplanation(data.explanation);

        quizBox.innerHTML = `
            <h2>${data.selected === data.correct ? "Correct!" : "Incorrect!"}</h2>
            <p><strong>Correct Answer:</strong> ${data.correct}</p>
            <div style="margin-top: 10px;">
                ${explanationFormatted}
            </div>
            <p style="font-size: 0.85em; color: #ccc; margin-top: 8px;">
                Note: Explanations are AI-generated for educational purposes.
            </p>
            <button class="btn" id="next-btn">Next Question</button>
        `;

        document.getElementById("next-btn").addEventListener("click", () => {
            currentIndex++;
            showQuestion();
        });
    });
}

// Helper function to convert AI explanation text into bullet lists
function formatExplanation(text) {
    // Split by numbered sections (1., 2., 3.) and create <ol> list
    const sections = text.split(/\d+\.\s+/).filter(s => s.trim() !== "");
    let html = "<ol>";
    sections.forEach(section => {
        // Further split into lines starting with "- " for nested bullets
        const lines = section.trim().split(/\n-\s+/).map(l => l.trim()).filter(l => l !== "");
        html += "<li>";
        if (lines.length > 0) {
            html += "<ul>";
            lines.forEach((line, i) => {
                if (i === 0) {
                    html += `<li>${line}</li>`; // main section first line
                } else {
                    html += `<li>${line}</li>`;
                }
            });
            html += "</ul>";
        } else {
            html += section.trim();
        }
        html += "</li>";
    });
    html += "</ol>";
    return html;
}

document.addEventListener("DOMContentLoaded", showQuestion);
</script>
{% endblock %}