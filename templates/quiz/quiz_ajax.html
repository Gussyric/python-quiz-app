{% extends "base.html" %}
{% block title %}Quiz â€“ {{ language }}{% endblock %}

{% block content %}
<h1>{{ language | capitalize }} Quiz</h1>

<div id="quiz-box">Loading...</div>

<script>
const questions = {{ questions|tojson }};
let currentIndex = 0;
let score = 0;

function showQuestion() {
    if (currentIndex >= questions.length) {
        document.getElementById("quiz-box").innerHTML = `
            <h2>Quiz Finished!</h2>
            <p>Your Score: ${score} / ${questions.length}</p>
            <a href="{{ url_for('home') }}" class="btn">Back to Home</a>
        `;
        return;
    }

    const q = questions[currentIndex];
    const quizBox = document.getElementById("quiz-box");

    quizBox.innerHTML = `
        <h2>Question ${currentIndex + 1} / ${questions.length}</h2>
        <p>${q.question}</p>
        <ul id="options-list"></ul>
    `;

    const ul = document.getElementById("options-list");

    q.options.forEach(opt => {
        const li = document.createElement("li");
        const btn = document.createElement("button");
        btn.textContent = opt;
        btn.className = "btn";

        btn.addEventListener("click", () => {
            console.log("Button clicked:", opt); // Browser console debug

            submitAnswer(opt, q.answer, q.options);
        });

        li.appendChild(btn);
        ul.appendChild(li);
    });
}

function submitAnswer(selected, correct, options) {
    if (selected === correct) score++;

    const quizBox = document.getElementById("quiz-box");

    // Fetch AI-generated explanation from Flask
    fetch(`/quiz/{{ language }}/answer`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            question: questions[currentIndex].question,
            selected: selected,
            correct: correct,
            options: options
        })
    })
    .then(res => res.json())
    .then(data => {
        const explanation = data.explanation.replace(/\n/g, "<br>"); // Preserve line breaks
        quizBox.innerHTML = `
            <h2>${data.feedback_msg}</h2>
            <p><strong>Correct Answer:</strong> ${data.correct}</p>
            <div>${explanation}</div>
            <button class="btn" id="next-btn">Next Question</button>
        `;

        document.getElementById("next-btn").addEventListener("click", () => {
            currentIndex++;
            showQuestion();
        });
    })
    .catch(err => {
        console.error("Error fetching explanation:", err);
        quizBox.innerHTML += `<p>Could not load explanation. Please try again.</p>`;
    });
}

document.addEventListener("DOMContentLoaded", showQuestion);
</script>
{% endblock %}