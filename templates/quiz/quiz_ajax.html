{% extends "base.html" %}
{% block title %}Quiz â€“ {{ language }}{% endblock %}

{% block content %}
<h1>{{ language | capitalize }} Quiz</h1>

<!-- PROGRESS BAR ADDED -->
<div class="progress-container">
    <div class="progress-bar" id="progress-bar"></div>
</div>

<style>
.progress-container {
    width: 100%;
    background-color: #222;
    border-radius: 6px;
    height: 12px;
    margin-bottom: 15px;
    overflow: hidden;
}
.progress-bar {
    height: 100%;
    width: 0%;
    background-color: #4caf50;
    transition: width 0.35s ease;
}
</style>

<div id="quiz-box">Loading...</div>

<script>
const questions = {{ questions|tojson }};
let currentIndex = 0;
let score = 0;

// Store answered questions so we can show explanation when going back
let answered = {};  
// Structure:
// answered[index] = { selected: ..., correct: ..., explanation: ... }

// Update progress bar
function updateProgress() {
    const bar = document.getElementById("progress-bar");
    const percent = (currentIndex / questions.length) * 100;
    bar.style.width = percent + "%";
}

function showQuestion() {
    updateProgress();

    // If going forward past final question
    if (currentIndex >= questions.length) {
        updateProgress();
        document.getElementById("quiz-box").innerHTML = `
            <h2>Quiz Finished!</h2>
            <p>Your Score: ${score} / ${questions.length}</p>
            <a href="{{ url_for('home') }}" class="btn">Back to Home</a>
        `;
        return;
    }

    const quizBox = document.getElementById("quiz-box");

    // If this question was already answered, DO NOT ALLOW re-answer
    if (answered[currentIndex]) {
        const record = answered[currentIndex];

        quizBox.innerHTML = `
            <h2>Question ${currentIndex + 1} / ${questions.length}</h2>
            <p>${questions[currentIndex].question}</p>

            <p><strong>Correct Answer:</strong> ${record.correct}</p>

            <div style="white-space: pre-wrap; margin-top: 10px;">
${record.explanation}
            </div>

            <p style="font-size: 0.85em; color: #ccc; margin-top: 8px;">
                Note: Explanations are AI-generated for educational purposes.
            </p>

            <div style="margin-top: 15px;">
                ${currentIndex > 0 ? `<button class="btn" id="prev-btn">Previous Question</button>` : ""}
                <button class="btn" id="return-btn">Return to Current Question</button>
            </div>
        `;

        if (currentIndex > 0) {
            document.getElementById("prev-btn").addEventListener("click", () => {
                currentIndex--;
                showQuestion();
            });
        }

        document.getElementById("return-btn").addEventListener("click", () => {
            currentIndex = getFirstUnanswered();
            showQuestion();
        });

        return;
    }

    // If question has NOT been answered yet (normal behavior)
    const q = questions[currentIndex];
    quizBox.innerHTML = `
        <h2>Question ${currentIndex + 1} / ${questions.length}</h2>
        <p>${q.question}</p>
        <ul id="options-list"></ul>

        <div style="margin-top: 15px;">
            ${currentIndex > 0 ? `<button class="btn" id="prev-btn">Previous Question</button>` : ""}
        </div>
    `;

    const ul = document.getElementById("options-list");

    q.options.forEach(opt => {
        const li = document.createElement("li");
        const btn = document.createElement("button");
        btn.textContent = opt;
        btn.className = "btn";

        btn.addEventListener("click", () => {
            submitAnswer(opt, q.answer, q.options);
        });

        li.appendChild(btn);
        ul.appendChild(li);
    });

    if (currentIndex > 0) {
        document.getElementById("prev-btn").addEventListener("click", () => {
            currentIndex--;
            showQuestion();
        });
    }
}

function submitAnswer(selected, correct, options) {
    const quizBox = document.getElementById("quiz-box");

    if (selected === correct) score++;

    fetch(`/quiz/{{ language }}/answer`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            question: questions[currentIndex].question,
            selected,
            correct,
            options
        })
    })
    .then(res => res.json())
    .then(data => {

        answered[currentIndex] = {
            selected,
            correct,
            explanation: data.explanation.trim()
        };

        quizBox.innerHTML = `
            <h2>${data.selected === data.correct ? "Correct!" : "Incorrect!"}</h2>
            <p><strong>Correct Answer:</strong> ${data.correct}</p>

            <div style="white-space: pre-wrap; margin-top: 10px;">
${data.explanation.trim()}
            </div>

            <p style="font-size: 0.85em; color: #ccc; margin-top: 8px;">
                Note: Explanations are AI-generated for educational purposes.
            </p>

            <div style="margin-top: 15px;">
                ${currentIndex > 0 ? `<button class="btn" id="prev-btn">Previous Question</button>` : ""}
                <button class="btn" id="next-btn">Next Question</button>
            </div>
        `;

        if (currentIndex > 0) {
            document.getElementById("prev-btn").addEventListener("click", () => {
                currentIndex--;
                showQuestion();
            });
        }

        document.getElementById("next-btn").addEventListener("click", () => {
            currentIndex++;
            showQuestion();
        });
    });
}

function getFirstUnanswered() {
    for (let i = 0; i < questions.length; i++) {
        if (!answered[i]) return i;
    }
    return questions.length;
}

document.addEventListener("DOMContentLoaded", showQuestion);
</script>
{% endblock %}


